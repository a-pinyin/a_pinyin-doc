# 多设备同步

A 拼音支持在多个平台的多个设备上使用.

多设备同步功能用于在多个设备之间同步用户数据,
比如对用户输入习惯的学习数据.

## 数据库目录及文件

A 拼音的数据库使用 `sqlite` 且按照以下方式存放:

数据库目录 (数据库存储位置):

- Android: `/sdcard/Android/data/org.fm_elpac.a_pinyin.ui/files/db/`

- Linux: `~/.config/a_pinyin-2/db/`

- Windows: `%appdata%/a_pinyin-2/db/`

数据库文件名:

- `a_pinyin-2.db` 内置数据库 (只读)

- `a_pinyin-2u.db` 用户数据库 (主要, 设备本地)

- (多个) `2u_UUID.db` 远程同步用户数据库镜像

- `2u_合并.db` 远程同步合并数据库 (第二数据库)

## 整体同步方案

采用多数据库设计, 每个远程设备对应一个本地数据库镜像 (`2u_UUID.db`) 文件, 使用 UUID 标记每个设备.

`2u_UUID.db` 仅用于远程同步时使用,
同步结束后对所有 `2u_UUID.db` 的数据进行合并,
生成 `2u_合并.db` 用于平时的查询.

平时查询用户数据时, 将查询 `a_pinyin-2u.db` 和 `2u_合并.db`.

其中 `a_pinyin-2u.db`, `2u_UUID.db`, `2u_合并.db`
的数据库结构设计完全一致,
都是用户数据库的设计, 这样可以简化设计.

## 具体同步技术方案

传输数据时考虑使用压缩/加密等技术.

- **全量同步**

  一次性拉取对方所有用户数据库的数据.

  用于第一次同步和同步出错之后的修复.

- **增量同步**

  仅拉取上次同步以来新增/变更的数据.

  用于减少传输的数据, 加快同步速度.

  增量同步之后, 计算数据校验值, 验证同步的一致性.

- **导入 1.x 数据库** (TODO)

  导入旧版 A 拼音 (1.x) 的用户数据库,
  尽量保留用户输入习惯数据.

  旧版 A 拼音作为一个远程设备对待.

### 增量同步 4 次握手协议

1. (发送) **请求数据摘要**

   获取对方设备用户数据摘要信息.

2. (接收) **数据摘要响应**

3. (发送) **请求增量数据**

   包含请求范围及指纹信息 (用来保证和之前收到摘要的一致性).

4. (接收) **增量数据响应**

   更新本地数据 (合并) 并校验同步的一致性.

### 增量同步数据校验方式

- 随机指纹校验

  比如随机抽取 256 条旧数据进行验证.

- 总条数, 总次数, 时间范围 等

## 具体同步操作方式

- **手动同步**

  手动复制另一个设备的用户数据库文件过来,
  并导入应用.

  属于全量同步.
  虽然操作麻烦, 但是实现简单.

- **通过网络自动同步**

  由于 A 拼音应用 (`a_pinyin.apk`) 本身不连网,
  此功能需要借助 FMLS 胖蚊子轻蜘蛛.
  暂时无法实现.

  包括 设备发现, 全量同步, 增量同步.
